{% extends "template.njk" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% set projectValue = [] %}
{% set milestoneValue = [] %}
{% set milestoneFields = [] %}

{% set cellBlock = "cell-color-"  %}
{% set flag = '' %}
{% set missedMilestonesCount = 0 %}

{% set project = project() | await %}

{% block beforeContent %}
{% include "feedback.njk" %}
{{ govukBackLink({
  text: "Back",
  href: "#",
  attributes: {
    onclick: "history.go(-1);"
  }
}) }}
{% endblock %}

{% block pageTitle %}Project Details{% endblock %}

{% block content %}

{% set projectKey = [{ text:'Project UID' }, { text:'Impact' }, { text:'HMG Confidence' }, { text:'Citizen Readiness' }, { text:'Business Readiness' }, { text:'EU Member State Delivery Confidence' }, { text:'Missed milestones' }, { text:'Themes' }] %}
{% set milestoneKey = [{ text:'Milestone UID' }, { text:'Milestone Description' }, { text:'Due Date' }, { text:'Latest Comments' }] %}

  {% for tableFieldId in tableFields %}

    {% set field = project.fields.get(tableFieldId) %}

    {% set projectValue = (projectValue.push({html:
    "<span class=" + cellBlock + field.value + ">" + field.value | default('N/A') + "</span>" | safe }), projectValue) %}
  {% endfor %}

  {% for milestone in project.milestones %}
    {% set milestoneValue = [] %}
    {% set flag = '' %}
    {% for tableFieldId in milestoneTableFields %}
      {% set field = milestone.fields.get(tableFieldId) %}

      {% if (field.id == 'date') and (field.value | beforeToDay) %}
        {% set flag = 'red-date' %}
        {% set missedMilestonesCount = missedMilestonesCount + 1 %}
      {% endif %}

      {% set milestoneValue = (milestoneValue.push({html: "<span class=" + flag + ">" + field.value | date("D MMM YYYY") + "</span>" | safe if field.id == 'date' else
      "<span>" + field.value | default('N/A') + "</span>" | safe }), milestoneValue) %}

    {% endfor %}
    {% set milestoneFields = (milestoneFields.push(milestoneValue), milestoneFields) %}

  {% endfor %}

{% set projectValue = (projectValue.push({
      html: "<span>" + missedMilestonesCount + "</span>" | safe }, {
      html: "<span>" + project.fields.get('deliveryTheme').value| default('N/A') + "</span>" | safe }),
    projectValue) %}

{% set milestonesHtml %}
 {% include "project-details/partials/accordion-info/milestones-table.njk" %}
{% endset %}

{% set deliveryStatusHtml %}
 {% include "project-details/partials/accordion-info/current-delivery-status.njk" %}
{% endset %}

{% set HMGdeliveryHTML %}
 {% include "project-details/partials/accordion-info/hmg-delivery.njk" %}
{% endset %}

{% set citizenReadinessHtml %}
 {% include "project-details/partials/accordion-info/citizen-readiness.njk" %}
{% endset %}

{% set businessReadinessHtml %}
 {% include "project-details/partials/accordion-info/business-readiness.njk" %}
{% endset %}

{% set EUmemberStateHtml %}
 {% include "project-details/partials/accordion-info/eu-member-state.njk" %}
{% endset %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-xl project-name">{{ project.title }}</h1>
    <span class="govuk-caption-xl dept-name">{{ project.department_name }}</span>

{% include "project-details/partials/project-tabs.njk" %}

{% include "project-details/partials/project-table.njk" %}

<a class="govuk-link" href="{{ config.paths.impactDefinitions }}">View impact and confidence definitions</a>

{% include "project-details/partials/accordion-details.njk" %}

 </div>
</div>

{% endblock %}
